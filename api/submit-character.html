<?php
// Enable error reporting for debugging
error_reporting(E_ALL);
ini_set('display_errors', 1);

header('Content-Type: text/html; charset=UTF-8');
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Submission API</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: white;
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .success { background: #4CAF50; }
        .error { background: #f44336; }
        .info { background: #ff6b35; }
        .character-data {
            background: #2a2a2a;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .submission-info {
            background: #333;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .submission-info h3 {
            color: #ff6b35;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <h1>Character Submission System</h1>
    
    <?php
    // Simple character submission system
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        try {
            // Get character data
            $json_input = file_get_contents('php://input');
            if (empty($json_input)) {
                throw new Exception('No data received');
            }
            
            $characterData = json_decode($json_input, true);
            
            if (json_last_error() !== JSON_ERROR_NONE) {
                throw new Exception('JSON decode error: ' . json_last_error_msg());
            }
            
            if (!$characterData || !isset($characterData['name'])) {
                throw new Exception('Invalid character data submitted - missing name');
            }
            
            // Create data directory if it doesn't exist
            $dataDir = '../data';
            if (!is_dir($dataDir)) {
                if (!mkdir($dataDir, 0755, true)) {
                    throw new Exception('Failed to create data directory');
                }
            }
            
            // Create submission record
            $submission = [
                'id' => uniqid('char_', true),
                'character' => $characterData,
                'status' => 'pending',
                'submitted_at' => date('Y-m-d H:i:s'),
                'submitted_by' => $_SERVER['REMOTE_ADDR'] // Simple identification
            ];
            
            // Save to pending submissions file
            $pendingFile = '../data/pending-submissions.json';
            $pending = [];
            
            if (file_exists($pendingFile)) {
                $pendingJson = file_get_contents($pendingFile);
                if ($pendingJson === false) {
                    throw new Exception('Failed to read pending submissions file');
                }
                $pending = json_decode($pendingJson, true);
                if (json_last_error() !== JSON_ERROR_NONE) {
                    throw new Exception('Failed to parse existing submissions: ' . json_last_error_msg());
                }
            }
            
            $pending[$submission['id']] = $submission;
            $saveResult = file_put_contents($pendingFile, json_encode($pending, JSON_PRETTY_PRINT));
            if ($saveResult === false) {
                throw new Exception('Failed to save submission to file');
            }
            
            // Create Discord notification
            $discordWebhook = 'https://discordapp.com/api/webhooks/1442233189795106896/iIyJHwZ-V02DiX08e_3i8vYLpCUX-F2SXUzNRpmp2hJrDEOiIXzL-w6y5wE9Gh1O4G38';
            $message = [
                'content' => "üéÆ **New Character Submission**\n\n**Character:** {$characterData['name']}\n**Playbook:** {$characterData['playbook']}\n**Status:** Pending Review\n\nA moderator will review this submission shortly. You'll be notified when it's approved or needs changes.",
                'embeds' => [
                    [
                        'title' => 'Character: ' . $characterData['name'],
                        'description' => substr($characterData['bio'] ?? 'No bio provided', 0, 500),
                        'fields' => [
                            ['name' => 'Classification', 'value' => $characterData['classification'] ?? 'Unknown', 'inline' => true],
                            ['name' => 'Playbook', 'value' => $characterData['playbook'] ?? 'Unknown', 'inline' => true],
                            ['name' => 'Submission ID', 'value' => $submission['id'], 'inline' => true]
                        ],
                        'color' => 16711680 // Red color for pending
                    ]
                ]
            ];
            
            // Send Discord notification (if webhook is configured)
            if ($discordWebhook && $discordWebhook !== 'YOUR_DISCORD_WEBHOOK_URL') {
                $ch = curl_init($discordWebhook);
                curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($message));
                curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                curl_setopt($ch, CURLOPT_TIMEOUT, 10);
                
                $discordResponse = curl_exec($ch);
                $discordError = curl_error($ch);
                $discordHttpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                curl_close($ch);
                
                if ($discordError) {
                    error_log("Discord webhook error: " . $discordError);
                } elseif ($discordHttpCode !== 204) {
                    error_log("Discord webhook HTTP code: " . $discordHttpCode . " Response: " . $discordResponse);
                }
            }
            
            echo '<div class="status success">‚úÖ Character submitted successfully!</div>';
            echo '<div class="submission-info">';
            echo '<h3>Submission Details:</h3>';
            echo '<p><strong>Submission ID:</strong> ' . $submission['id'] . '</p>';
            echo '<p><strong>Status:</strong> Pending Review</p>';
            echo '<p><strong>Submitted:</strong> ' . $submission['submitted_at'] . '</p>';
            echo '<p><strong>Next Steps:</strong> A moderator will review your character. You will be notified on Discord when it\'s approved or if changes are needed.</p>';
            echo '</div>';
            
            echo '<div class="character-data">';
            echo '<h3>Character Sheet Preview:</h3>';
            echo htmlspecialchars(json_encode($characterData, JSON_PRETTY_PRINT));
            echo '</div>';
            
        } catch (Exception $e) {
            echo '<div class="status error">‚ùå Error: ' . htmlspecialchars($e->getMessage()) . '</div>';
            echo '<div class="submission-info">';
            echo '<h3>Debug Information:</h3>';
            echo '<p><strong>Request Method:</strong> ' . htmlspecialchars($_SERVER['REQUEST_METHOD']) . '</p>';
            echo '<p><strong>Content Type:</strong> ' . htmlspecialchars($_SERVER['CONTENT_TYPE'] ?? 'Not set') . '</p>';
            echo '<p><strong>Input Data:</strong> ' . htmlspecialchars(file_get_contents('php://input')) . '</p>';
            echo '</div>';
        }
        echo '<div class="status info">‚ÑπÔ∏è This is the character submission API endpoint. Use the character builder to submit characters.</div>';
    }
    ?>
    
    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #4a5568;">
        <p><a href="../character-builder.html" style="color: #ff6b35;">‚Üê Back to Character Builder</a></p>
        <p><a href="../characters/index.html" style="color: #ff6b35;">‚Üí View Character List</a></p>
    </div>
</body>
</html>
