<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Management - Dark City RPG</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/accessibility.css">
    <link rel="stylesheet" href="../css/mobile.css">
    <style>
        .character-management {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .management-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .management-header h1 {
            color: #ff6b35;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .management-header p {
            color: #ccc;
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .filter-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #444;
            padding-bottom: 1rem;
        }
        
        .filter-tab {
            padding: 0.75rem 1.5rem;
            background: #333;
            border: none;
            border-radius: 5px 5px 0 0;
            color: #ccc;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .filter-tab.active {
            background: #ff6b35;
            color: white;
        }
        
        .filter-tab:hover {
            background: #444;
        }
        
        .filter-tab.active:hover {
            background: #e55a2b;
        }
        
        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .character-card {
            background: #2a2a2a;
            border: 2px solid #4a5568;
            border-radius: 10px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .character-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .character-card.pending {
            border-color: #ff9800;
        }
        
        .character-card.approved {
            border-color: #4CAF50;
        }
        
        .character-card.rejected {
            border-color: #f44336;
        }
        
        .character-card.changes_requested {
            border-color: #2196F3;
        }
        
        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .status-badge.pending {
            background: #ff9800;
            color: white;
        }
        
        .status-badge.approved {
            background: #4CAF50;
            color: white;
        }
        
        .status-badge.rejected {
            background: #f44336;
            color: white;
        }
        
        .status-badge.changes_requested {
            background: #2196F3;
            color: white;
        }
        
        .character-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff6b35;
            margin-bottom: 1rem;
        }
        
        .character-info {
            margin-bottom: 1rem;
        }
        
        .character-info p {
            margin: 0.5rem 0;
            color: #ccc;
        }
        
        .character-info strong {
            color: white;
        }
        
        .character-bio {
            margin-bottom: 1rem;
            color: #ccc;
            font-style: italic;
            max-height: 3rem;
            overflow: hidden;
        }
        
        .character-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background: #45a049;
        }
        
        .btn-secondary {
            background: #2196F3;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #1976D2;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
        }
        
        .btn-outline {
            background: transparent;
            color: #ff6b35;
            border: 2px solid #ff6b35;
        }
        
        .btn-outline:hover {
            background: #ff6b35;
            color: white;
        }
        
        .no-characters {
            text-align: center;
            color: #ccc;
            font-size: 1.2rem;
            margin-top: 3rem;
        }
        
        .loading {
            text-align: center;
            color: #ff6b35;
            font-size: 1.2rem;
            margin-top: 3rem;
        }
        
        .feedback-section {
            background: #333;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
        }
        
        .feedback-section label {
            display: block;
            margin-bottom: 0.5rem;
            color: #ccc;
        }
        
        .feedback-section textarea {
            width: 100%;
            padding: 0.5rem;
            background: #2a2a2a;
            border: 2px solid #444;
            border-radius: 5px;
            color: white;
            resize: vertical;
            min-height: 80px;
        }
        
        .feedback-section textarea:focus {
            outline: none;
            border-color: #ff6b35;
        }
        
        .submission-date {
            font-size: 0.8rem;
            color: #888;
            margin-top: 0.5rem;
        }
        
        .playbook-tag {
            background: #444;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8rem;
            margin-right: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .character-management {
                padding: 1rem;
            }
            
            .management-header h1 {
                font-size: 2rem;
            }
            
            .character-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-tabs {
                flex-wrap: wrap;
            }
            
            .character-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-to-main">Skip to main content</a>
    
    <header role="banner">
        <nav role="navigation" aria-label="Main navigation">
            <div class="nav-container">
                <h1>Dark City</h1>
                <ul class="nav-links" role="menubar">
                    <li role="none"><a href="../index.html" role="menuitem">Home</a></li>
                    <li role="none"><a href="https://dark-city-game-production.up.railway.app/character-creator.html" role="menuitem">Character Creator</a></li>
                    <li role="none"><a href="../characters/gallery.html" role="menuitem">Character Gallery</a></li>
                    <li role="none"><a href="../characters/manage.html" role="menuitem" class="active">Manage Characters</a></li>
                    <li role="none"><a href="../playbooks/" role="menuitem">Playbooks</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <main role="main" id="main-content">
        <div class="character-management">
            <div class="management-header">
                <h1>Character Management</h1>
                <p>Review and manage character submissions. Approve, request changes, or reject characters to maintain quality standards.</p>
            </div>
            
            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="pending">üìã Pending</button>
                <button class="filter-tab" data-filter="approved">‚úÖ Approved</button>
                <button class="filter-tab" data-filter="rejected">‚ùå Rejected</button>
                <button class="filter-tab" data-filter="changes_requested">üìù Changes Requested</button>
                <button class="filter-tab" data-filter="all">üìä All Submissions</button>
            </div>
            
            <div id="loadingMessage" class="loading">
                Loading character submissions...
            </div>
            
            <div id="characterGrid" class="character-grid">
                <!-- Characters will be loaded here -->
            </div>
            
            <div id="noCharactersMessage" class="no-characters" style="display: none;">
                No characters found for this filter.
            </div>
        </div>
    </main>

    <!-- Character Detail Modal -->
    <div id="characterModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modalCharacterDetails">
                <!-- Character details will be loaded here -->
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2024 Dark City RPG. Built with GitHub Pages.</p>
        </div>
    </footer>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="../config.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/safe-dom.js"></script>
    <script src="../js/server-api.js"></script>
    <script src="../js/error-handler.js"></script>
    <style>
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }
        
        .modal-content {
            background-color: #2a2a2a;
            margin: 5% auto;
            padding: 2rem;
            border: 2px solid #ff6b35;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 10px;
        }
        
        .close:hover {
            color: white;
        }
        
        .character-detail {
            color: white;
        }
        
        .character-detail h2 {
            color: #ff6b35;
            margin-bottom: 1rem;
        }
        
        .character-detail .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .character-detail .info-item {
            background: #333;
            padding: 1rem;
            border-radius: 5px;
        }
        
        .character-detail .info-item strong {
            color: #ff6b35;
        }
        
        .character-detail .bio-section {
            background: #333;
            padding: 1.5rem;
            border-radius: 5px;
            margin: 1rem 0;
        }
        
        .character-detail .skills-section {
            background: #333;
            padding: 1.5rem;
            border-radius: 5px;
            margin: 1rem 0;
        }
        
        .character-detail .skills-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .character-detail .skill-level {
            background: #444;
            padding: 0.5rem;
            border-radius: 3px;
            text-align: center;
        }
        
        .character-detail .skill-level strong {
            color: #ff6b35;
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: center;
        }
    </style>
    <script>
        let allSubmissions = [];
        let currentFilter = 'pending';
        let serverAPI;
        let socket;
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', async () => {
            serverAPI = new ServerAPI();
            socket = serverAPI.initSocket();
            
            await loadSubmissions();
            setupFilters();
            setupModal();
            setupSocketListeners();
        });
        
        // Setup Socket.io listeners for real-time updates
        function setupSocketListeners() {
            if (!socket) return;
            
            socket.on('characterSubmitted', (data) => {
                // New character submitted - refresh the list
                loadSubmissions();
            });
            
            socket.on('characterApproved', (data) => {
                // Character approved - refresh the list
                loadSubmissions();
            });
            
            socket.on('characterRejected', (data) => {
                // Character rejected - refresh the list
                loadSubmissions();
            });
        }
        
        // Load character submissions from server
        async function loadSubmissions() {
            try {
                document.getElementById('loadingMessage').style.display = 'block';
                
                // Load submissions based on current filter
                if (currentFilter === 'pending') {
                    allSubmissions = await serverAPI.getPendingSubmissions();
                } else if (currentFilter === 'approved') {
                    allSubmissions = await serverAPI.getApprovedCharacters();
                } else {
                    allSubmissions = await serverAPI.getAllSubmissions();
                }
                
                displaySubmissions();
                document.getElementById('loadingMessage').style.display = 'none';
                
            } catch (error) {
                console.error('Error loading submissions from server:', error);
                document.getElementById('loadingMessage').style.display = 'none';
                
                // Show server connection error message
                const grid = document.getElementById('characterGrid');
                SafeDOM.setContent(grid, SafeDOM.createHTML('div', {
                    style: 'text-align: center; color: #ff6b35; padding: 2rem; grid-column: 1/-1;'
                }, [
                    SafeDOM.createHTML('h3', {}, ['üî¥ Server Connection Error']),
                    SafeDOM.createHTML('p', {}, ['Unable to connect to the Dark City server.']),
                    SafeDOM.createHTML('p', {}, ['Please ensure the server is running and accessible.']),
                    SafeDOM.createHTML('p', {}, ['Error: ' + error.message])
                ]));
            }
        }
        
        // Setup filter event listeners
        function setupFilters() {
            const filterTabs = document.querySelectorAll('.filter-tab');
            
            filterTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Update active tab
                    filterTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Update filter and reload
                    currentFilter = tab.dataset.filter;
                    loadSubmissions();
                });
            });
        }
        
        // Display submissions in the grid
        function displaySubmissions() {
            const grid = document.getElementById('characterGrid');
            const noCharactersMessage = document.getElementById('noCharactersMessage');
            
            SafeDOM.setContent(grid, '');
            
            // Filter submissions based on current filter
            let filteredSubmissions = allSubmissions;
            if (currentFilter !== 'all') {
                filteredSubmissions = allSubmissions.filter(submission => {
                    const status = submission.status || (submission.approved ? 'approved' : 'pending');
                    return status === currentFilter;
                });
            }
            
            if (filteredSubmissions.length === 0) {
                noCharactersMessage.style.display = 'block';
                return;
            }
            
            noCharactersMessage.style.display = 'none';
            
            filteredSubmissions.forEach(submission => {
                const card = createSubmissionCard(submission);
                grid.appendChild(card);
            });
        }
        
        // Create a submission card element
        function createSubmissionCard(submission) {
            const character = submission.character || submission;
            const status = submission.status || (submission.approved ? 'approved' : 'pending');
            
            const card = SafeDOM.createElement('div', {
                className: `character-card ${status.replace('_', '-')}`
            });
            
            const statusBadge = SafeDOM.createElement('div', {
                className: `status-badge ${status.replace('_', '-')}`
            }, getStatusText(status));
            
            const name = SafeDOM.createElement('div', {
                className: 'character-name'
            }, character.name || 'Unnamed Character');
            
            const info = SafeDOM.createHTML('div', {
                className: 'character-info'
            }, [
                SafeDOM.createHTML('p', {}, [`Playbook: ${character.playbook || 'Unknown'}`]),
                SafeDOM.createHTML('p', {}, [`Classification: ${character.classification || 'Unknown'}`]),
                SafeDOM.createHTML('p', {}, [`Subtype: ${character.subtype || 'None'}`]),
                SafeDOM.createHTML('p', {}, [`Age: ${character.apparentAge || 'Unknown'}${character.actualAge ? ` (${character.actualAge})` : ''}`])
            ]);
            
            const bio = SafeDOM.createHTML('div', {
                className: 'character-bio'
            }, character.bio ? character.bio.substring(0, 150) + (character.bio.length > 150 ? '...' : '') : 'No bio available');
            
            const submissionDate = SafeDOM.createHTML('div', {
                className: 'submission-date'
            }, `Submitted: ${new Date(submission.submittedAt || submission.createdAt).toLocaleDateString()}`);
            
            const actions = createActionButtons(submission, status);
            
            card.appendChild(statusBadge);
            card.appendChild(name);
            card.appendChild(info);
            card.appendChild(bio);
            card.appendChild(submissionDate);
            card.appendChild(actions);
            
            return card;
        }
        
        // Create action buttons based on status
        function createActionButtons(submission, status) {
            const actions = SafeDOM.createHTML('div', {
                className: 'character-actions'
            });
            
            const viewBtn = SafeDOM.createElement('button', {
                className: 'btn btn-outline',
                onclick: () => showCharacterDetail(submission)
            }, 'üëÅÔ∏è View Details');
            
            actions.appendChild(viewBtn);
            
            if (status === 'pending') {
                const approveBtn = SafeDOM.createElement('button', {
                    className: 'btn btn-primary',
                    onclick: () => approveCharacter(submission.id)
                }, '‚úÖ Approve');
                
                const changesBtn = SafeDOM.createElement('button', {
                    className: 'btn btn-secondary',
                    onclick: () => requestChanges(submission.id)
                }, 'üìù Request Changes');
                
                const rejectBtn = SafeDOM.createElement('button', {
                    className: 'btn btn-danger',
                    onclick: () => rejectCharacter(submission.id)
                }, '‚ùå Reject');
                
                actions.appendChild(approveBtn);
                actions.appendChild(changesBtn);
                actions.appendChild(rejectBtn);
            } else if (status === 'changes_requested') {
                const approveBtn = SafeDOM.createElement('button', {
                    className: 'btn btn-primary',
                    onclick: () => approveCharacter(submission.id)
                }, '‚úÖ Approve');
                
                const rejectBtn = SafeDOM.createElement('button', {
                    className: 'btn btn-danger',
                    onclick: () => rejectCharacter(submission.id)
                }, '‚ùå Reject');
                
                actions.appendChild(approveBtn);
                actions.appendChild(rejectBtn);
            }
            
            return actions;
        }
        
        // Get status text for display
        function getStatusText(status) {
            const statusMap = {
                'pending': 'üìã Pending',
                'approved': '‚úÖ Approved',
                'rejected': '‚ùå Rejected',
                'changes_requested': 'üìù Changes Requested'
            };
            return statusMap[status] || status;
        }
        
        // Approve character
        async function approveCharacter(characterId) {
            try {
                const feedback = prompt('Optional: Add feedback for the player (leave empty for no feedback):');
                await serverAPI.approveCharacter(characterId, feedback || '', 'moderator');
                alert('Character approved successfully!');
                await loadSubmissions(); // Refresh the list
            } catch (error) {
                console.error('Error approving character:', error);
                alert('Error approving character. Please try again.');
            }
        }
        
        // Request changes
        async function requestChanges(characterId) {
            const feedback = prompt('Please provide feedback on what changes are needed:');
            if (!feedback || feedback.trim() === '') {
                alert('Please provide feedback for the requested changes.');
                return;
            }
            
            try {
                await serverAPI.rejectCharacter(characterId, feedback, 'moderator');
                alert('Changes requested successfully!');
                await loadSubmissions(); // Refresh the list
            } catch (error) {
                console.error('Error requesting changes:', error);
                alert('Error requesting changes. Please try again.');
            }
        }
        
        // Reject character
        async function rejectCharacter(characterId) {
            const feedback = prompt('Please provide feedback for the rejection:');
            if (!feedback || feedback.trim() === '') {
                alert('Please provide feedback for the rejection.');
                return;
            }
            
            try {
                await serverAPI.rejectCharacter(characterId, feedback, 'moderator');
                alert('Character rejected successfully!');
                await loadSubmissions(); // Refresh the list
            } catch (error) {
                console.error('Error rejecting character:', error);
                alert('Error rejecting character. Please try again.');
            }
        }
        
        // Setup modal functionality
        function setupModal() {
            const modal = document.getElementById('characterModal');
            const closeBtn = modal.querySelector('.close');
            
            closeBtn.onclick = () => {
                modal.style.display = 'none';
            };
            
            window.onclick = (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            };
        }
        
        // Show character detail in modal
        function showCharacterDetail(submission) {
            const modal = document.getElementById('characterModal');
            const modalContent = document.getElementById('modalCharacterDetails');
            const character = submission.character || submission;
            const status = submission.status || (submission.approved ? 'approved' : 'pending');
            
            const detailHTML = `
                <div class="character-detail">
                    <h2>${character.name || 'Unnamed Character'}</h2>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <strong>Status:</strong> <span class="status-badge ${status.replace('_', '-')}">${getStatusText(status)}</span>
                        </div>
                        <div class="info-item">
                            <strong>Playbook:</strong> ${character.playbook || 'Unknown'}
                        </div>
                        <div class="info-item">
                            <strong>Classification:</strong> ${character.classification || 'Unknown'}
                        </div>
                        <div class="info-item">
                            <strong>Subtype:</strong> ${character.subtype || 'None'}
                        </div>
                        <div class="info-item">
                            <strong>Apparent Age:</strong> ${character.apparentAge || 'Unknown'}
                        </div>
                        ${character.actualAge ? `
                        <div class="info-item">
                            <strong>Actual Age:</strong> ${character.actualAge}
                        </div>
                        ` : ''}
                        <div class="info-item">
                            <strong>Fate Points:</strong> ${character.fatePoints || '1'}/5
                        </div>
                        <div class="info-item">
                            <strong>Submitted:</strong> ${new Date(submission.submittedAt || submission.createdAt).toLocaleDateString()}
                        </div>
                    </div>
                    
                    <div class="bio-section">
                        <h3>Biography</h3>
                        <p>${character.bio || 'No biography available.'}</p>
                    </div>
                    
                    ${character.humanHeight || character.humanWeight ? `
                    <div class="info-grid">
                        <div class="info-item">
                            <strong>Human Form - Height:</strong> ${character.humanHeight || 'Unknown'}
                        </div>
                        <div class="info-item">
                            <strong>Human Form - Weight:</strong> ${character.humanWeight || 'Unknown'}
                        </div>
                        ${character.monsterHeight ? `
                        <div class="info-item">
                            <strong>Monster Form - Height:</strong> ${character.monsterHeight}
                        </div>
                        ` : ''}
                        ${character.monsterWeight ? `
                        <div class="info-item">
                            <strong>Monster Form - Weight:</strong> ${character.monsterWeight}
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    ${character.skills && Object.keys(character.skills).length > 0 ? `
                    <div class="skills-section">
                        <h3>Skills</h3>
                        <div class="skills-grid">
                            ${Object.entries(character.skills).map(([skill, level]) => 
                                `<div class="skill-level"><strong>${level}:</strong> ${skill}</div>`
                            ).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${submission.feedback ? `
                    <div class="bio-section">
                        <h3>Moderator Feedback</h3>
                        <p>${submission.feedback}</p>
                    </div>
                    ` : ''}
                    
                    <div class="modal-actions">
                        ${status === 'pending' ? `
                            <button class="btn btn-primary" onclick="approveCharacter('${submission.id}')">‚úÖ Approve</button>
                            <button class="btn btn-secondary" onclick="requestChanges('${submission.id}')">üìù Request Changes</button>
                            <button class="btn btn-danger" onclick="rejectCharacter('${submission.id}')">‚ùå Reject</button>
                        ` : status === 'changes_requested' ? `
                            <button class="btn btn-primary" onclick="approveCharacter('${submission.id}')">‚úÖ Approve</button>
                            <button class="btn btn-danger" onclick="rejectCharacter('${submission.id}')">‚ùå Reject</button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            modalContent.innerHTML = detailHTML;
            modal.style.display = 'block';
        }
    </script>
</body>
</html>
