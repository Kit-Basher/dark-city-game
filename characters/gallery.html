<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Gallery - Dark City RPG</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/accessibility.css">
    <link rel="stylesheet" href="../css/mobile.css">
    <style>
        .character-gallery {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .gallery-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .gallery-header h1 {
            color: #ff6b35;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .gallery-header p {
            color: #ccc;
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .filter-section {
            background: #333;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        
        .filter-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }
        
        .filter-controls label {
            color: #ccc;
            font-weight: 500;
        }
        
        .filter-controls select,
        .filter-controls input {
            padding: 0.5rem;
            background: #2a2a2a;
            border: 2px solid #444;
            border-radius: 5px;
            color: white;
        }
        
        .filter-controls select:focus,
        .filter-controls input:focus {
            outline: none;
            border-color: #ff6b35;
        }
        
        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .character-card {
            background: #2a2a2a;
            border: 2px solid #4a5568;
            border-radius: 10px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .character-card:hover {
            transform: translateY(-5px);
            border-color: #ff6b35;
            box-shadow: 0 10px 25px rgba(255, 107, 53, 0.2);
        }
        
        .character-card.approved {
            border-color: #4CAF50;
        }
        
        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4CAF50;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .character-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff6b35;
            margin-bottom: 1rem;
        }
        
        .character-info {
            margin-bottom: 1rem;
        }
        
        .character-info p {
            margin: 0.5rem 0;
            color: #ccc;
        }
        
        .character-info strong {
            color: white;
        }
        
        .character-bio {
            margin-bottom: 1rem;
            color: #ccc;
            font-style: italic;
            max-height: 3rem;
            overflow: hidden;
        }
        
        .character-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #ff6b35;
            color: white;
        }
        
        .btn-primary:hover {
            background: #e55a2b;
        }
        
        .btn-outline {
            background: transparent;
            color: #ff6b35;
            border: 2px solid #ff6b35;
        }
        
        .btn-outline:hover {
            background: #ff6b35;
            color: white;
        }
        
        .no-characters {
            text-align: center;
            color: #ccc;
            font-size: 1.2rem;
            margin-top: 3rem;
        }
        
        .loading {
            text-align: center;
            color: #ff6b35;
            font-size: 1.2rem;
            margin-top: 3rem;
        }
        
        .stats-row {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #ccc;
        }
        
        .playbook-tag {
            background: #444;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8rem;
            margin-right: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .character-gallery {
                padding: 1rem;
            }
            
            .gallery-header h1 {
                font-size: 2rem;
            }
            
            .character-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .character-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-to-main">Skip to main content</a>
    
    <header role="banner">
        <nav role="navigation" aria-label="Main navigation">
            <div class="nav-container">
                <h1>Dark City</h1>
                <ul class="nav-links" role="menubar">
                    <li role="none"><a href="../index.html" role="menuitem">Home</a></li>
                    <li role="none"><a href="../character-creator.html" role="menuitem">Character Creator</a></li>
                    <li role="none"><a href="../characters/gallery.html" role="menuitem" class="active">Character Gallery</a></li>
                    <li role="none"><a href="../characters/manage.html" role="menuitem">Manage Characters</a></li>
                    <li role="none"><a href="../playbooks/" role="menuitem">Playbooks</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <main role="main" id="main-content">
        <div class="character-gallery">
            <div class="gallery-header">
                <h1>Character Gallery</h1>
                <p>Browse approved character sheets from Dark City players. Click on any character to view their full details.</p>
            </div>
            
            <div class="filter-section">
                <div class="filter-controls">
                    <label for="playbookFilter">Filter by Playbook:</label>
                    <select id="playbookFilter">
                        <option value="">All Playbooks</option>
                    </select>
                    
                    <label for="classificationFilter">Filter by Classification:</label>
                    <select id="classificationFilter">
                        <option value="">All Classifications</option>
                    </select>
                    
                    <label for="searchInput">Search:</label>
                    <input type="text" id="searchInput" placeholder="Search characters...">
                </div>
            </div>
            
            <div id="loadingMessage" class="loading">
                Loading characters...
            </div>
            
            <div id="characterGrid" class="character-grid">
                <!-- Characters will be loaded here -->
            </div>
            
            <div id="noCharactersMessage" class="no-characters" style="display: none;">
                No approved characters found. Be the first to <a href="../character-creator.html">create a character</a>!
            </div>
        </div>
    </main>

    <!-- Character Detail Modal -->
    <div id="characterModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modalCharacterDetails">
                <!-- Character details will be loaded here -->
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2024 Dark City RPG. Built with GitHub Pages.</p>
        </div>
    </footer>

    <script src="../config.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/safe-dom.js"></script>
    <script src="../js/server-api.js"></script>
    <script src="../js/error-handler.js"></script>
    <style>
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }
        
        .modal-content {
            background-color: #2a2a2a;
            margin: 5% auto;
            padding: 2rem;
            border: 2px solid #ff6b35;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 10px;
        }
        
        .close:hover {
            color: white;
        }
        
        .character-detail {
            color: white;
        }
        
        .character-detail h2 {
            color: #ff6b35;
            margin-bottom: 1rem;
        }
        
        .character-detail .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .character-detail .info-item {
            background: #333;
            padding: 1rem;
            border-radius: 5px;
        }
        
        .character-detail .info-item strong {
            color: #ff6b35;
        }
        
        .character-detail .bio-section {
            background: #333;
            padding: 1.5rem;
            border-radius: 5px;
            margin: 1rem 0;
        }
        
        .character-detail .skills-section {
            background: #333;
            padding: 1.5rem;
            border-radius: 5px;
            margin: 1rem 0;
        }
        
        .character-detail .skills-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .character-detail .skill-level {
            background: #444;
            padding: 0.5rem;
            border-radius: 3px;
            text-align: center;
        }
        
        .character-detail .skill-level strong {
            color: #ff6b35;
        }
    </style>
    <script>
        let allCharacters = [];
        let filteredCharacters = [];
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCharacters();
            setupFilters();
            setupModal();
        });
        
        // Load approved characters from server
        async function loadCharacters() {
            try {
                const serverAPI = new ServerAPI();
                allCharacters = await serverAPI.getApprovedCharacters();
                
                if (allCharacters.length === 0) {
                    // Fallback to GitHub API if server has no characters
                    allCharacters = await loadCharactersFromGitHub();
                }
                
                filteredCharacters = [...allCharacters];
                populateFilters();
                displayCharacters();
                
                document.getElementById('loadingMessage').style.display = 'none';
                
            } catch (error) {
                console.error('Error loading characters:', error);
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('noCharactersMessage').style.display = 'block';
            }
        }
        
        // Load characters from GitHub API as fallback
        async function loadCharactersFromGitHub() {
            try {
                const response = await fetch(`https://api.github.com/repos/${window.CONFIG?.REPO_OWNER || 'Kit-Basher'}/${window.CONFIG?.REPO_NAME || 'dark-city-game'}/contents/characters?ref=main`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch from GitHub');
                }
                
                const files = await response.json();
                const characterFiles = files.filter(file => file.name.endsWith('.json'));
                
                const characters = [];
                for (const file of characterFiles) {
                    try {
                        const contentResponse = await fetch(file.download_url);
                        const characterData = await contentResponse.json();
                        
                        // Only show approved characters
                        if (characterData.approved) {
                            characters.push({
                                ...characterData,
                                id: file.name.replace('.json', ''),
                                url: file.html_url
                            });
                        }
                    } catch (error) {
                        console.warn('Failed to load character file:', file.name);
                    }
                }
                
                return characters;
            } catch (error) {
                console.error('Error loading from GitHub:', error);
                return [];
            }
        }
        
        // Populate filter dropdowns
        function populateFilters() {
            const playbooks = [...new Set(allCharacters.map(char => char.playbook).filter(Boolean))];
            const classifications = [...new Set(allCharacters.map(char => char.classification).filter(Boolean))];
            
            const playbookFilter = document.getElementById('playbookFilter');
            const classificationFilter = document.getElementById('classificationFilter');
            
            playbooks.forEach(playbook => {
                const option = SafeDOM.createElement('option', { value: playbook }, playbook);
                playbookFilter.appendChild(option);
            });
            
            classifications.forEach(classification => {
                const option = SafeDOM.createElement('option', { value: classification }, classification);
                classificationFilter.appendChild(option);
            });
        }
        
        // Setup filter event listeners
        function setupFilters() {
            const playbookFilter = document.getElementById('playbookFilter');
            const classificationFilter = document.getElementById('classificationFilter');
            const searchInput = document.getElementById('searchInput');
            
            function filterCharacters() {
                const playbookValue = playbookFilter.value.toLowerCase();
                const classificationValue = classificationFilter.value.toLowerCase();
                const searchValue = searchInput.value.toLowerCase();
                
                filteredCharacters = allCharacters.filter(character => {
                    const matchesPlaybook = !playbookValue || character.playbook?.toLowerCase() === playbookValue;
                    const matchesClassification = !classificationValue || character.classification?.toLowerCase() === classificationValue;
                    const matchesSearch = !searchValue || 
                        character.name?.toLowerCase().includes(searchValue) ||
                        character.bio?.toLowerCase().includes(searchValue) ||
                        character.subtype?.toLowerCase().includes(searchValue);
                    
                    return matchesPlaybook && matchesClassification && matchesSearch;
                });
                
                displayCharacters();
            }
            
            playbookFilter.addEventListener('change', filterCharacters);
            classificationFilter.addEventListener('change', filterCharacters);
            searchInput.addEventListener('input', filterCharacters);
        }
        
        // Display characters in the grid
        function displayCharacters() {
            const grid = document.getElementById('characterGrid');
            const noCharactersMessage = document.getElementById('noCharactersMessage');
            
            SafeDOM.setContent(grid, '');
            
            if (filteredCharacters.length === 0) {
                noCharactersMessage.style.display = 'block';
                return;
            }
            
            noCharactersMessage.style.display = 'none';
            
            filteredCharacters.forEach(character => {
                const card = createCharacterCard(character);
                grid.appendChild(card);
            });
        }
        
        // Create a character card element
        function createCharacterCard(character) {
            const card = SafeDOM.createElement('div', {
                className: 'character-card approved',
                onclick: () => showCharacterDetail(character)
            });
            
            const statusBadge = SafeDOM.createElement('div', {
                className: 'status-badge'
            }, 'âœ… APPROVED');
            
            const name = SafeDOM.createElement('div', {
                className: 'character-name'
            }, character.name || 'Unnamed Character');
            
            const info = SafeDOM.createHTML('div', {
                className: 'character-info'
            }, [
                SafeDOM.createHTML('p', {}, [`Playbook: ${character.playbook || 'Unknown'}`]),
                SafeDOM.createHTML('p', {}, [`Classification: ${character.classification || 'Unknown'}`]),
                SafeDOM.createHTML('p', {}, [`Subtype: ${character.subtype || 'None'}`]),
                SafeDOM.createHTML('p', {}, [`Age: ${character.apparentAge || 'Unknown'}${character.actualAge ? ` (${character.actualAge})` : ''}`])
            ]);
            
            const bio = SafeDOM.createHTML('div', {
                className: 'character-bio'
            }, character.bio ? character.bio.substring(0, 150) + (character.bio.length > 150 ? '...' : '') : 'No bio available');
            
            const stats = SafeDOM.createHTML('div', {
                className: 'stats-row'
            }, [
                SafeDOM.createHTML('span', { className: 'playbook-tag' }, [character.playbook || 'Unknown']),
                SafeDOM.createHTML('span', {}, [`FP: ${character.fatePoints || '1'}/5`])
            ]);
            
            card.appendChild(statusBadge);
            card.appendChild(name);
            card.appendChild(info);
            card.appendChild(bio);
            card.appendChild(stats);
            
            return card;
        }
        
        // Setup modal functionality
        function setupModal() {
            const modal = document.getElementById('characterModal');
            const closeBtn = modal.querySelector('.close');
            
            closeBtn.onclick = () => {
                modal.style.display = 'none';
            };
            
            window.onclick = (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            };
        }
        
        // Show character detail in modal
        function showCharacterDetail(character) {
            const modal = document.getElementById('characterModal');
            const modalContent = document.getElementById('modalCharacterDetails');
            
            const detailHTML = `
                <div class="character-detail">
                    <h2>${character.name || 'Unnamed Character'}</h2>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <strong>Playbook:</strong> ${character.playbook || 'Unknown'}
                        </div>
                        <div class="info-item">
                            <strong>Classification:</strong> ${character.classification || 'Unknown'}
                        </div>
                        <div class="info-item">
                            <strong>Subtype:</strong> ${character.subtype || 'None'}
                        </div>
                        <div class="info-item">
                            <strong>Apparent Age:</strong> ${character.apparentAge || 'Unknown'}
                        </div>
                        ${character.actualAge ? `
                        <div class="info-item">
                            <strong>Actual Age:</strong> ${character.actualAge}
                        </div>
                        ` : ''}
                        <div class="info-item">
                            <strong>Fate Points:</strong> ${character.fatePoints || '1'}/5
                        </div>
                    </div>
                    
                    <div class="bio-section">
                        <h3>Biography</h3>
                        <p>${character.bio || 'No biography available.'}</p>
                    </div>
                    
                    ${character.humanHeight || character.humanWeight ? `
                    <div class="info-grid">
                        <div class="info-item">
                            <strong>Human Form - Height:</strong> ${character.humanHeight || 'Unknown'}
                        </div>
                        <div class="info-item">
                            <strong>Human Form - Weight:</strong> ${character.humanWeight || 'Unknown'}
                        </div>
                        ${character.monsterHeight ? `
                        <div class="info-item">
                            <strong>Monster Form - Height:</strong> ${character.monsterHeight}
                        </div>
                        ` : ''}
                        ${character.monsterWeight ? `
                        <div class="info-item">
                            <strong>Monster Form - Weight:</strong> ${character.monsterWeight}
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    ${character.skills && Object.keys(character.skills).length > 0 ? `
                    <div class="skills-section">
                        <h3>Skills</h3>
                        <div class="skills-grid">
                            ${Object.entries(character.skills).map(([skill, level]) => 
                                `<div class="skill-level"><strong>${level}:</strong> ${skill}</div>`
                            ).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${character.specialResources ? `
                    <div class="bio-section">
                        <h3>Special Resources</h3>
                        <p>${character.specialResources}</p>
                    </div>
                    ` : ''}
                    
                    ${character.connections ? `
                    <div class="bio-section">
                        <h3>Connections</h3>
                        <p>${character.connections}</p>
                    </div>
                    ` : ''}
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <p><small>Character submitted on ${new Date(character.submittedAt || character.createdAt).toLocaleDateString()}</small></p>
                    </div>
                </div>
            `;
            
            modalContent.innerHTML = detailHTML;
            modal.style.display = 'block';
        }
    </script>
</body>
</html>
