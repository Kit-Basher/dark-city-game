<!DOCTYPE html>
<html lang="en">
<head>
    <script>
window.ENV = window.ENV || {};
window.ENV.API_KEY = '860de3877c2de19b8c88f34c34b71580';
window.ENV.JWT_SECRET = 'vEahCndVJYE4s/hkNuJ9EMW3xjfgWh+kq+XmYumxAsQ=';
window.ENV.NODE_ENV = 'development';
window.ENV.REPO_OWNER = 'Kit-Basher';
window.ENV.REPO_NAME = 'dark-city-game';
window.ENV.ENABLE_GITHUB_INTEGRATION = 'false';
window.ENV.ENABLE_DISCORD_NOTIFICATIONS = 'false';
window.ENV.CALENDAR_MONTHS_TO_LOAD = '3';
window.ENV.MAX_CHARACTERS_PER_PAGE = '12';
window.ENV.ALLOWED_ORIGINS = 'http://localhost:3000,http://localhost:8080,https://kit-basher.github.io';
</script>
    <script>
window.ENV = window.ENV || {};
window.ENV.API_KEY = '860de3877c2de19b8c88f34c34b71580';
window.ENV.JWT_SECRET = 'vEahCndVJYE4s/hkNuJ9EMW3xjfgWh+kq+XmYumxAsQ=';
window.ENV.NODE_ENV = 'development';
window.ENV.REPO_OWNER = 'Kit-Basher';
window.ENV.REPO_NAME = 'dark-city-game';
window.ENV.ENABLE_GITHUB_INTEGRATION = 'false';
window.ENV.ENABLE_DISCORD_NOTIFICATIONS = 'false';
window.ENV.CALENDAR_MONTHS_TO_LOAD = '3';
window.ENV.MAX_CHARACTERS_PER_PAGE = '12';
window.ENV.ALLOWED_ORIGINS = 'http://localhost:3000,http://localhost:8080,https://kit-basher.github.io';
</script>
    <script>
window.ENV = window.ENV || {};
window.ENV.API_KEY = '860de3877c2de19b8c88f34c34b71580';
window.ENV.JWT_SECRET = 'vEahCndVJYE4s/hkNuJ9EMW3xjfgWh+kq+XmYumxAsQ=';
window.ENV.NODE_ENV = 'development';
window.ENV.REPO_OWNER = 'Kit-Basher';
window.ENV.REPO_NAME = 'dark-city-game';
window.ENV.ENABLE_GITHUB_INTEGRATION = 'false';
window.ENV.ENABLE_DISCORD_NOTIFICATIONS = 'false';
window.ENV.CALENDAR_MONTHS_TO_LOAD = '3';
window.ENV.MAX_CHARACTERS_PER_PAGE = '12';
window.ENV.ALLOWED_ORIGINS = 'http://localhost:3000,http://localhost:8080,https://kit-basher.github.io';
</script>
    <script>
window.ENV = window.ENV || {};
window.ENV.API_KEY = '860de3877c2de19b8c88f34c34b71580';
window.ENV.JWT_SECRET = 'vEahCndVJYE4s/hkNuJ9EMW3xjfgWh+kq+XmYumxAsQ=';
window.ENV.NODE_ENV = 'development';
window.ENV.REPO_OWNER = 'Kit-Basher';
window.ENV.REPO_NAME = 'dark-city-game';
window.ENV.ENABLE_GITHUB_INTEGRATION = 'false';
window.ENV.ENABLE_DISCORD_NOTIFICATIONS = 'false';
window.ENV.CALENDAR_MONTHS_TO_LOAD = '3';
window.ENV.MAX_CHARACTERS_PER_PAGE = '12';
window.ENV.ALLOWED_ORIGINS = 'http://localhost:3000,http://localhost:8080,https://kit-basher.github.io';
</script>
    <meta charset="UTF-8">
    <title>Moderator Panel - Dark City RPG</title>
    <meta name="description" content="Moderator panel for reviewing and managing character submissions">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåô</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css?v=2.2.19" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css?v=6.0.0" rel="stylesheet">
    <script src="config.js?v=1.0.1"></script>
    <script src="js/env-loader.js?v=1.0.1"></script>
    <script src="js/input-sanitizer.js?v=1.0.1"></script>
    <script src="js/server-api.js?v=1.0.1"></script>
    <script src="js/error-handler.js?v=1.0.1"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-red-500 mb-2">
                <i class="fas fa-gavel"></i> Moderator Panel
            </h1>
            <p class="text-gray-400">Review and manage character submissions</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Pending Characters -->
            <section class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-2xl font-semibold text-yellow-400 mb-4">
                    <i class="fas fa-clock"></i> Pending Characters
                </h2>
                <div id="pending-characters" class="space-y-4">
                    <div class="text-gray-500 text-center py-8">
                        <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                        <p>Loading pending characters...</p>
                    </div>
                </div>
            </section>

            <!-- Recent Approvals -->
            <section class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-2xl font-semibold text-green-400 mb-4">
                    <i class="fas fa-check-circle"></i> Recent Approvals
                </h2>
                <div id="approved-characters" class="space-y-4">
                    <div class="text-gray-500 text-center py-8">
                        <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                        <p>Loading approved characters...</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- Moderator Password Management -->
        <section class="bg-gray-800 rounded-lg p-6 mt-8">
            <h2 class="text-2xl font-semibold text-purple-400 mb-4">
                <i class="fas fa-key"></i> Moderator Settings
            </h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Current Moderator Password</label>
                    <input type="password" id="current-password" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2" placeholder="Enter current password">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">New Moderator Password</label>
                    <input type="password" id="new-password" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2" placeholder="Enter new password (min 4 chars)">
                </div>
                <button onclick="updateModeratorPassword()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg font-semibold">
                    <i class="fas fa-key"></i> Update Password
                </button>
            </div>
        </section>

        <!-- All Approved Characters Section -->
        <section class="bg-gray-800 rounded-lg p-6 mt-8">
            <h2 class="text-2xl font-semibold text-blue-400 mb-4">
                <i class="fas fa-users"></i> All Approved Characters
                <span class="text-sm text-gray-400 ml-2">(Moderator: Delete characters when needed)</span>
            </h2>
            <div id="all-approved-characters" class="space-y-4">
                <div class="text-gray-500 text-center py-8">
                    <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                    <p>Loading all approved characters...</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Character Review Modal -->
    <div id="review-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-gray-800 rounded-lg max-w-4xl w-full max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-bold text-red-400">Character Review</h3>
                        <button onclick="closeReviewModal()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div id="character-details" class="mb-6">
                        <!-- Character details will be loaded here -->
                    </div>
                    
                    <div class="border-t border-gray-700 pt-4">
                        <h4 class="text-lg font-semibold mb-3">Moderator Actions</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Feedback (optional)</label>
                                <textarea id="feedback-text" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2" rows="3" placeholder="Add feedback for the player..."></textarea>
                            </div>
                            
                            <div class="flex space-x-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Moderator Password</label>
                                    <input type="password" id="moderator-password" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2" placeholder="test123">
                                </div>
                            </div>
                            
                            <div class="flex space-x-4">
                                <button onclick="approveCharacter()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-semibold">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button onclick="rejectCharacter()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-semibold">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentCharacter = null;
        const serverAPI = new ServerAPI();

        // Load Socket.io with fallback
        let socket = null;
        try {
            if (typeof io !== 'undefined') {
                socket = io(serverAPI.socketURL);
                socket.on('connect', () => {
                    console.log('Connected to server for real-time updates');
                });
                socket.on('newSubmission', () => {
                    loadPendingCharacters();
                });
                socket.on('characterApproved', () => {
                    loadApprovedCharacters();
                    loadPendingCharacters();
                });
            } else {
                console.warn('Socket.io not available - using polling mode');
                // Poll for updates every 30 seconds
                setInterval(() => {
                    loadPendingCharacters();
                    loadApprovedCharacters();
                }, 30000);
            }
        } catch (error) {
            console.warn('Socket.io initialization failed:', error);
        }

        // Load pending characters
        async function loadPendingCharacters() {
            try {
                console.log('üîç Loading pending characters from API...');
                const response = await fetch(`${window.APP_CONFIG.apiURL}/characters/pending`, {
                    headers: {
                        'Authorization': `Bearer ${window.APP_CONFIG.API_KEY}`
                    }
                });
                const data = await response.json();
                console.log('üìä API response:', data);
                const characters = Array.isArray(data) ? data : (data.characters || []);
                console.log('‚úÖ Extracted characters:', characters);
                
                const container = document.getElementById('pending-characters');
                
                if (characters.length === 0) {
                    container.innerHTML = `
                        <div class="text-gray-500 text-center py-8">
                            <i class="fas fa-inbox text-4xl mb-4"></i>
                            <p>No pending characters</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = characters.map(character => `
                    <div class="bg-gray-700 rounded-lg p-4 hover:bg-gray-600 transition-colors">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-lg font-semibold text-yellow-400">${character.name}</h3>
                                <p class="text-sm text-gray-400">${character.classification} ‚Ä¢ ${character.playbook}</p>
                                <p class="text-sm text-gray-500 mt-2">Submitted: ${new Date(character.submittedAt).toLocaleDateString()}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editCharacter('${character._id}')" class="bg-orange-600 hover:bg-orange-700 px-3 py-1 rounded text-sm" title="Edit Character">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button onclick="openReviewModal('${character._id}')" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">
                                    <i class="fas fa-eye"></i> Review
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading pending characters:', error);
                document.getElementById('pending-characters').innerHTML = `
                    <div class="text-red-500 text-center py-8">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Error loading pending characters</p>
                    </div>
                `;
            }
        }

        // Load approved characters
        async function loadApprovedCharacters() {
            try {
                const response = await fetch(`${window.APP_CONFIG.apiURL}/characters?limit=5`, {
                    headers: {
                        'Authorization': `Bearer ${window.APP_CONFIG.API_KEY}`
                    }
                });
                const data = await response.json();
                const characters = Array.isArray(data) ? data : (data.characters || []);
                
                const container = document.getElementById('approved-characters');
                
                if (characters.length === 0) {
                    container.innerHTML = `
                        <div class="text-gray-500 text-center py-8">
                            <i class="fas fa-inbox text-4xl mb-4"></i>
                            <p>No approved characters</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = characters.map(character => `
                    <div class="bg-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-lg font-semibold text-green-400">${character.name}</h3>
                                <p class="text-sm text-gray-400">${character.classification} ‚Ä¢ ${character.playbook}</p>
                                <p class="text-sm text-gray-500 mt-1">Approved by: ${character.reviewedBy}</p>
                                ${character.feedback ? `<p class="text-sm text-blue-400 mt-2">"${character.feedback}"</p>` : ''}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editCharacter('${character._id}')" class="bg-orange-600 hover:bg-orange-700 px-3 py-1 rounded text-sm" title="Edit Character">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <span class="text-xs text-green-400">
                                    <i class="fas fa-check-circle"></i> Approved
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading approved characters:', error);
                document.getElementById('approved-characters').innerHTML = `
                    <div class="text-red-500 text-center py-8">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Error loading approved characters</p>
                    </div>
                `;
            }
        }

        // Open review modal
        async function openReviewModal(characterId) {
            try {
                const response = await fetch(`${window.APP_CONFIG.apiURL}/characters/pending`, {
                    headers: {
                        'Authorization': `Bearer ${window.APP_CONFIG.API_KEY}`
                    }
                });
                const data = await response.json();
                const characters = Array.isArray(data) ? data : (data.characters || []);
                currentCharacter = characters.find(c => c._id === characterId);
                
                if (!currentCharacter) {
                    alert('Character not found');
                    return;
                }
                
                // Display character details
                const details = document.getElementById('character-details');
                details.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold text-red-400 mb-2">Character Photos</h4>
                            <div class="flex gap-4 mb-4">
                                ${currentCharacter.humanPhoto ? `
                                <div class="text-center">
                                    <img src="${currentCharacter.humanPhoto}" alt="${currentCharacter.name} - Human Form" class="w-24 h-24 rounded-lg border-2 border-gray-600 object-cover mb-1">
                                    <p class="text-xs text-gray-400">üë§ Human</p>
                                </div>
                                ` : '<div class="text-center"><div class="w-24 h-24 rounded-lg border-2 border-dashed border-gray-600 flex items-center justify-center mb-1"><span class="text-gray-500 text-xs">No Human Photo</span></div><p class="text-xs text-gray-400">üë§ Human</p></div>'}
                                
                                ${currentCharacter.monsterPhoto ? `
                                <div class="text-center">
                                    <img src="${currentCharacter.monsterPhoto}" alt="${currentCharacter.name} - Monster Form" class="w-24 h-24 rounded-lg border-2 border-gray-600 object-cover mb-1">
                                    <p class="text-xs text-gray-400">üëπ Monster</p>
                                </div>
                                ` : '<div class="text-center"><div class="w-24 h-24 rounded-lg border-2 border-dashed border-gray-600 flex items-center justify-center mb-1"><span class="text-gray-500 text-xs">No Monster Photo</span></div><p class="text-xs text-gray-400">üëπ Monster</p></div>'}
                            </div>
                            
                            <h4 class="font-semibold text-red-400 mb-2">Basic Info</h4>
                            <p><strong>Name:</strong> ${currentCharacter.name}</p>
                            <p><strong>Classification:</strong> ${currentCharacter.classification}</p>
                            <p><strong>Playbook:</strong> ${currentCharacter.playbook}</p>
                            <p><strong>Apparent Age:</strong> ${currentCharacter.apparentAge}</p>
                            <p><strong>Actual Age:</strong> ${currentCharacter.actualAge}</p>
                            <p><strong>Status:</strong> <span class="text-yellow-400">${currentCharacter.status}</span></p>
                        </div>
                        <div>
                            <h4 class="font-semibold text-red-400 mb-2">Background</h4>
                            <p><strong>Bio:</strong> ${currentCharacter.bio || 'Not provided'}</p>
                        </div>
                    </div>
                    
                    ${currentCharacter.moves && currentCharacter.moves.length > 0 ? `
                        <div class="mt-4">
                            <h4 class="font-semibold text-red-400 mb-2">Moves</h4>
                            <ul class="list-disc list-inside text-gray-300">
                                ${currentCharacter.moves.map(move => `<li>${move.name}: ${move.description}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                `;
                
                document.getElementById('review-modal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading character details:', error);
                alert('Error loading character details');
            }
        }

        // Close review modal
        function closeReviewModal() {
            document.getElementById('review-modal').classList.add('hidden');
            currentCharacter = null;
            document.getElementById('feedback-text').value = '';
        }

        // Approve character
        async function approveCharacter() {
            if (!currentCharacter) return;
            
            try {
                const feedback = document.getElementById('feedback-text').value;
                const moderatorPassword = document.getElementById('moderator-password').value;
                
                if (!moderatorPassword) {
                    alert('Moderator password is required');
                    return;
                }
                
                // Disable buttons to prevent multiple clicks
                const approveBtn = document.querySelector('button[onclick="approveCharacter()"]');
                const rejectBtn = document.querySelector('button[onclick="rejectCharacter()"]');
                if (approveBtn) {
                    approveBtn.disabled = true;
                    approveBtn.textContent = 'Approving...';
                    approveBtn.classList.add('opacity-50');
                }
                if (rejectBtn) {
                    rejectBtn.disabled = true;
                    rejectBtn.classList.add('opacity-50');
                }
                
                const response = await fetch(`${window.APP_CONFIG.apiURL}/characters/${currentCharacter._id}/approve`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.APP_CONFIG.API_KEY}`
                    },
                    body: JSON.stringify({
                        moderatorPassword,
                        reviewedBy: 'moderator',
                        feedback: feedback
                    })
                });
                
                if (response.ok) {
                    // Use setTimeout for non-blocking alert
                    setTimeout(() => {
                        alert('Character approved successfully!');
                    }, 100);
                    
                    closeReviewModal();
                    // Refresh lists in parallel
                    await Promise.all([
                        loadPendingCharacters(),
                        loadApprovedCharacters()
                    ]);
                } else {
                    throw new Error('Approval failed');
                }
                
            } catch (error) {
                console.error('Error approving character:', error);
                setTimeout(() => {
                    alert('Error approving character. Please try again.');
                }, 100);
            } finally {
                // Re-enable buttons
                const approveBtn = document.querySelector('button[onclick="approveCharacter()"]');
                const rejectBtn = document.querySelector('button[onclick="rejectCharacter()"]');
                if (approveBtn) {
                    approveBtn.disabled = false;
                    approveBtn.textContent = 'Approve';
                    approveBtn.classList.remove('opacity-50');
                }
                if (rejectBtn) {
                    rejectBtn.disabled = false;
                    rejectBtn.classList.remove('opacity-50');
                }
            }
        }

        // Reject character
        async function rejectCharacter() {
            if (!currentCharacter) return;
            
            const feedback = document.getElementById('feedback-text').value;
            const moderatorPassword = document.getElementById('moderator-password').value;
            
            if (!feedback) {
                alert('Feedback is required for rejection');
                return;
            }
            
            if (!moderatorPassword) {
                alert('Moderator password is required');
                return;
            }
            
            const confirmed = confirm(`Are you sure you want to reject "${currentCharacter.name}"?`);
            if (!confirmed) return;
            
            try {
                const response = await fetch(`${window.APP_CONFIG.apiURL}/characters/${currentCharacter._id}/reject`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.APP_CONFIG.API_KEY}`
                    },
                    body: JSON.stringify({
                        moderatorPassword,
                        feedback,
                        reviewedBy: 'moderator'
                    })
                });
                
                if (response.ok) {
                    alert(`Character "${currentCharacter.name}" rejected with feedback.`);
                    closeReviewModal();
                    loadPendingCharacters();
                } else {
                    const error = await response.json();
                    alert(`Error rejecting character: ${error.error}`);
                }
            } catch (error) {
                console.error('Error rejecting character:', error);
                alert('Error rejecting character. Please try again.');
            }
        }

        // Load all approved characters (with delete functionality)
        async function loadAllApprovedCharacters() {
            try {
                const response = await fetch(`${window.APP_CONFIG.apiURL}/characters?status=approved&limit=50`, {
                    headers: {
                        'Authorization': `Bearer ${window.APP_CONFIG.API_KEY}`
                    }
                });
                const data = await response.json();
                const characters = Array.isArray(data) ? data : (data.characters || []);
                
                const container = document.getElementById('all-approved-characters');
                
                if (characters.length === 0) {
                    container.innerHTML = `
                        <div class="text-gray-500 text-center py-8">
                            <i class="fas fa-users text-4xl mb-4"></i>
                            <p>No approved characters found</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = characters.map(character => {
                    // Create safe filename for profile link
                    const safeName = character.name
                        .toLowerCase()
                        .replace(/[^a-z0-9]/g, '-')
                        .replace(/-+/g, '-')
                        .replace(/^-|-$/g, '');
                    
                    const bioText = character.bio ? 
                        `<p class="text-gray-400 mt-2 text-sm">${character.bio.substring(0, 100)}${character.bio.length > 100 ? '...' : ''}</p>` : '';
                    
                    return `<div class="bg-gray-700 rounded-lg p-4 border border-gray-600">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-white mb-2">${character.name}</h3>
                                <div class="grid grid-cols-2 gap-2 text-sm text-gray-300">
                                    <span><i class="fas fa-tag"></i> ${character.classification}</span>
                                    <span><i class="fas fa-book"></i> ${character.playbook}</span>
                                    <span><i class="fas fa-birthday-cake"></i> ${character.apparentAge}</span>
                                    <span><i class="fas fa-calendar"></i> ${new Date(character.submittedAt).toLocaleDateString()}</span>
                                </div>
                                ${bioText}
                                <div class="mt-2">
                                    <span class="text-xs text-green-400">
                                        <i class="fas fa-file-alt"></i> Profile: https://dark-city-game-production.up.railway.app/characters/profiles/${safeName}-${character._id}.html
                                    </span>
                                </div>
                            </div>
                            <div class="flex flex-col space-y-2 ml-4">
                                <button onclick="window.open('https://dark-city-game-production.up.railway.app/characters/profiles/${safeName}-${character._id}.html', '_blank')" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-sm">
                                    <i class="fas fa-user-circle"></i> Profile
                                </button>
                                <button onclick="viewCharacterDetails('${character._id}')" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button onclick="deleteCharacter('${character._id}', '${character.name}', event)" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>`}).join('');

            } catch (error) {
                console.error('Error loading all approved characters:', error);
                document.getElementById('all-approved-characters').innerHTML = `
                    <div class="text-red-500 text-center py-8">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Error loading approved characters</p>
                    </div>
                `;
            }
        }

        // Delete character with confirmation
        async function deleteCharacter(characterId, characterName, event) {
            // Prevent any default browser behavior
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // Use a non-blocking confirmation
            const confirmed = confirm(`Are you sure you want to delete "${characterName}"? This action cannot be undone.`);
            if (!confirmed) {
                return;
            }

            try {
                // Disable the button to prevent multiple clicks
                const button = event ? event.target : null;
                if (button) {
                    button.disabled = true;
                    button.textContent = 'Deleting...';
                    button.classList.add('opacity-50');
                }

                const response = await fetch(`${window.APP_CONFIG.apiURL}/characters/${characterId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${window.APP_CONFIG.API_KEY}`
                    }
                });

                if (response.ok) {
                    // Use setTimeout to make the alert non-blocking
                    setTimeout(() => {
                        alert(`Character "${characterName}" has been deleted successfully.`);
                    }, 100);
                    
                    // Refresh character lists in parallel instead of sequentially
                    await Promise.all([
                        loadAllApprovedCharacters(),
                        loadApprovedCharacters()
                    ]);
                } else {
                    throw new Error('Delete failed');
                }
                
            } catch (error) {
                console.error('Error deleting character:', error);
                setTimeout(() => {
                    alert('Error deleting character. Please try again.');
                }, 100);
            } finally {
                // Re-enable the button
                const button = event ? event.target : null;
                if (button) {
                    button.disabled = false;
                    button.textContent = 'Delete';
                    button.classList.remove('opacity-50');
                }
            }
        }

        // View character details (reuse review modal but without approval buttons)
        async function viewCharacterDetails(characterId) {
            try {
                const response = await fetch(`${window.APP_CONFIG.apiURL}/characters/pending`, {
                    headers: {
                        'Authorization': `Bearer ${window.APP_CONFIG.API_KEY}`
                    }
                });
                const data = await response.json();
                const characters = Array.isArray(data) ? data : (data.characters || []);
                
                // Look for the character in both pending and approved
                const allCharacters = [...characters];
                const approvedResponse = await fetch(`${window.APP_CONFIG.apiURL}/characters?status=approved&limit=50`, {
                    headers: {
                        'Authorization': `Bearer ${window.APP_CONFIG.API_KEY}`
                    }
                });
                const approvedData = await approvedResponse.json();
                allCharacters.push(...(Array.isArray(approvedData) ? approvedData : (approvedData.characters || [])));
                
                const character = allCharacters.find(c => c._id === characterId);
                
                if (!character) {
                    alert('Character not found');
                    return;
                }

                currentCharacter = character;
                
                // Show character details in modal
                const detailsHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold text-red-400 mb-2">Character Photos</h4>
                            <div class="flex gap-4 mb-4">
                                ${character.humanPhoto ? `
                                <div class="text-center">
                                    <img src="${character.humanPhoto}" alt="${character.name} - Human Form" class="w-24 h-24 rounded-lg border-2 border-gray-600 object-cover mb-1">
                                    <p class="text-xs text-gray-400">üë§ Human</p>
                                </div>
                                ` : '<div class="text-center"><div class="w-24 h-24 rounded-lg border-2 border-dashed border-gray-600 flex items-center justify-center mb-1"><span class="text-gray-500 text-xs">No Human Photo</span></div><p class="text-xs text-gray-400">üë§ Human</p></div>'}
                                
                                ${character.monsterPhoto ? `
                                <div class="text-center">
                                    <img src="${character.monsterPhoto}" alt="${character.name} - Monster Form" class="w-24 h-24 rounded-lg border-2 border-gray-600 object-cover mb-1">
                                    <p class="text-xs text-gray-400">üëπ Monster</p>
                                </div>
                                ` : '<div class="text-center"><div class="w-24 h-24 rounded-lg border-2 border-dashed border-gray-600 flex items-center justify-center mb-1"><span class="text-gray-500 text-xs">No Monster Photo</span></div><p class="text-xs text-gray-400">üëπ Monster</p></div>'}
                            </div>
                            
                            <h4 class="font-semibold text-red-400 mb-2">Basic Info</h4>
                            <p><strong>Name:</strong> ${character.name}</p>
                            <p><strong>Classification:</strong> ${character.classification}</p>
                            <p><strong>Playbook:</strong> ${character.playbook}</p>
                            <p><strong>Apparent Age:</strong> ${character.apparentAge}</p>
                            <p><strong>Actual Age:</strong> ${character.actualAge}</p>
                            <p><strong>Status:</strong> <span class="text-green-400">${character.status}</span></p>
                        </div>
                        <div>
                            <h4 class="font-semibold text-red-400 mb-2">Background</h4>
                            <p><strong>Bio:</strong> ${character.bio || 'Not provided'}</p>
                        </div>
                    </div>
                    
                    ${character.moves && character.moves.length > 0 ? `
                        <div class="mt-4">
                            <h4 class="font-semibold text-red-400 mb-2">Moves</h4>
                            <ul class="list-disc list-inside text-gray-300">
                                ${character.moves.map(move => `<li>${move.name}: ${move.description}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                `;
                
                document.getElementById('character-details').innerHTML = detailsHtml;
                document.getElementById('review-modal').classList.remove('hidden');
                
                // Hide approval buttons for viewing only
                const modalActions = document.querySelector('.border-t.border-gray-700.pt-4');
                if (modalActions) {
                    modalActions.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error viewing character:', error);
                alert('Error loading character details');
            }
        }

        // Edit character with moderator access
        function editCharacter(characterId) {
            // Open edit page in new tab with moderator access
            const editUrl = `characters/character-edit.html?id=${characterId}`;
            window.open(editUrl, '_blank');
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üîÑ Loading moderator panel V2...');
            loadPendingCharacters();
            loadApprovedCharacters();
            loadAllApprovedCharacters();
        });
    </script>
</body>
</html>
