<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Submission API</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: white;
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .success { background: #4CAF50; }
        .error { background: #f44336; }
        .info { background: #ff6b35; }
        .character-data {
            background: #2a2a2a;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .submission-info {
            background: #333;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .submission-info h3 {
            color: #ff6b35;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <h1>Character Submission System</h1>
    
    <?php
    // Simple character submission system
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        // Get character data
        $characterData = json_decode(file_get_contents('php://input'), true);
        
        if (!$characterData || !isset($characterData['name'])) {
            echo '<div class="status error">‚ùå Invalid character data submitted</div>';
            exit;
        }
        
        // Create submission record
        $submission = [
            'id' => uniqid('char_', true),
            'character' => $characterData,
            'status' => 'pending',
            'submitted_at' => date('Y-m-d H:i:s'),
            'submitted_by' => $_SERVER['REMOTE_ADDR'] // Simple identification
        ];
        
        // Save to pending submissions file
        $pendingFile = '../data/pending-submissions.json';
        $pending = [];
        
        if (file_exists($pendingFile)) {
            $pending = json_decode(file_get_contents($pendingFile), true);
        }
        
        $pending[$submission['id']] = $submission;
        file_put_contents($pendingFile, json_encode($pending, JSON_PRETTY_PRINT));
        
        // Create Discord notification
        $discordWebhook = 'https://discordapp.com/api/webhooks/1442228498629525586/6mJC4zV2BvAkOSt_7EiGmOc4Yaj8vGtJupDOQwlzVr_-D-muR_aSRnorqsX_a3yTDxWr';
        $message = [
            'content' => "üéÆ **New Character Submission**\n\n**Character:** {$characterData['name']}\n**Playbook:** {$characterData['playbook']}\n**Status:** Pending Review\n\nA moderator will review this submission shortly. You'll be notified when it's approved or needs changes.",
            'embeds' => [
                [
                    'title' => 'Character: ' . $characterData['name'],
                    'description' => substr($characterData['bio'] ?? 'No bio provided', 0, 500),
                    'fields' => [
                        ['name' => 'Classification', 'value' => $characterData['classification'] ?? 'Unknown', 'inline' => true],
                        ['name' => 'Playbook', 'value' => $characterData['playbook'] ?? 'Unknown', 'inline' => true],
                        ['name' => 'Submission ID', 'value' => $submission['id'], 'inline' => true]
                    ],
                    'color' => 16711680 // Red color for pending
                ]
            ]
        ];
        
        // Send Discord notification (if webhook is configured)
        if ($discordWebhook && $discordWebhook !== 'YOUR_DISCORD_WEBHOOK_URL') {
            $ch = curl_init($discordWebhook);
            curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($message));
            curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
            curl_exec($ch);
            curl_close($ch);
        }
        
        echo '<div class="status success">‚úÖ Character submitted successfully!</div>';
        echo '<div class="submission-info">';
        echo '<h3>Submission Details:</h3>';
        echo '<p><strong>Submission ID:</strong> ' . $submission['id'] . '</p>';
        echo '<p><strong>Status:</strong> Pending Review</p>';
        echo '<p><strong>Submitted:</strong> ' . $submission['submitted_at'] . '</p>';
        echo '<p><strong>Next Steps:</strong> A moderator will review your character. You will be notified on Discord when it\'s approved or if changes are needed.</p>';
        echo '</div>';
        
        echo '<div class="character-data">';
        echo '<h3>Character Sheet Preview:</h3>';
        echo htmlspecialchars(json_encode($characterData, JSON_PRETTY_PRINT));
        echo '</div>';
        
    } else {
        echo '<div class="status info">‚ÑπÔ∏è This is the character submission API endpoint. Use the character builder to submit characters.</div>';
    }
    ?>
    
    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #4a5568;">
        <p><a href="../character-builder.html" style="color: #ff6b35;">‚Üê Back to Character Builder</a></p>
        <p><a href="../characters/index.html" style="color: #ff6b35;">‚Üí View Character List</a></p>
    </div>
</body>
</html>
